#! /usr/bin/ruby

require 'optparse'
require 'routes'
require 'digest'

def file_contents(path)
  @file_contents ||= {}
  @file_contents[path] ||= open(path, 'r').read
rescue Errno::ENOENT
  nil
end

def routes_rb_md5
  @routes_rb_md5 ||= Digest::MD5.hexdigest(file_contents("config/routes.rb"))
end

def checksum_md5_contents
  @checksum_md5_contents ||= file_contents(".routes/checksum.md5")  
end

def checksum_md5_update
  open('.routes/checksum.md5', 'w') { |f| f.write routes_rb_md5 }
end



options = {}
OptionParser.new do |opts|
opts.banner = "Usage: routes [options]"

opts.on("-i", "--init", "Initialize the routes cache") do |v|
options[:init] = 1
end

opts.on("-v", "--version", "Version") do |v|
options[:version] = 1
end

end.parse!

#p options
#p ARGV

if options.include? :version
  puts Routes::VERSION
  exit
end

# is Dir .routess exist
if Dir.glob(".routes").empty?
  Dir.mkdir(".routes")
end

if options.include?(:init) || routes_rb_md5 != checksum_md5_contents
  cmd = ENV['ROUTES_CMD'] || "rake routes"
  puts "Updating routes cache"
  if system "#{cmd} > .routes/routes.txt"
    checksum_md5_update
  end
end

cmd = "cat .routes/routes.txt"
ARGV.each do|a|
  cmd << " | grep -i #{a}"
end

system cmd

